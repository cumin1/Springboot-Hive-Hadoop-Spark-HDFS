<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Files</title>
    <link rel="stylesheet" href="../css/link3.css">
</head>

<body>
    <div class="container">
        <div class="button-group">
            <button class="btn" onclick="goBack()">Go Back</button>
        </div>
        <h2 class="title">点击按钮可上传图片</h2>

        <div class="upload-container">
            <label for="file-input" class="file-label">Choose file</label>
            <input type="file" id="file-input" onchange="uploadFile(event, '/hdfs/file/uploadImage')"
                accept=".jpg, .jpeg, .png, .gif, .txt, .csv, .mp4" style="display: none;">
        </div>

        <div class="file-list">
            <h3>显示所有图片</h3>
            <div class="box">
                <ul id="file-list" class="file-list">
                    <!-- 这里将由 JavaScript 动态插入文件列表 -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        const images = [];
        const fileList = document.getElementById('file-list');

        async function fetchImages() {
            try {
                const response = await fetch('http://localhost:8080/hdfs/file/findImage');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // 服务器返回的是JSON格式的数据
                images.length = 0; // 清空 images 数组
                images.push(...data.data); // 将新数据追加到images数组
                renderFileList(images); // 更新文件列表
            } catch (error) {
                console.error('There was a problem with your fetch operation:', error);
            }
        }

        function renderFileList(files) {
            fileList.innerHTML = ''; // 清空现有列表

            files.forEach((file) => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.textContent = file;

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'delete-btn';
                deleteButton.onclick = () => handleDelete(file);

                li.appendChild(deleteButton);
                fileList.appendChild(li);
            });
        }

        // 在页面加载时获取并渲染文件列表
        window.onload = fetchImages;

        // 上传文件的函数
        function uploadFile(event, uploadpoint) {
            const file = event.target.files[0];
            console.log(`Uploading ${file.name} to ${uploadpoint}`);

            const formData = new FormData();
            formData.append('file', file);

            // 发送 POST 请求
            fetch('http://localhost:8080' + uploadpoint, {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json(); // 假设服务器返回 JSON 格式的数据
                })
                .then(data => {
                    console.log('Upload successful:', data);
                    fetchImages();// 上传成功后，更新文件列表
                    alert(data.message);
                })
                .catch(error => {
                    console.error('There was a problem with your upload:', error);
                });
            event.target.value = '';// 清空文件输入框的值

        }

        function downloadFile(fileName) {
            alert('Downloading ' + fileName);
            // Implement actual download functionality
        }

        // 删除文件的函数
        async function handleDelete(image) {
            console.log(`点击了删除按钮: ${image}`);
            // 弹出确认对话框
            const isConfirmed = confirm(`Are you sure you want to delete ${image}?`);

            if (!isConfirmed) {
                // 用户点击取消，不执行删除操作
                return;
            }
            try {
                const response = await fetch(`http://localhost:8080/hdfs/file/deleteImage/${image}`, {
                    method: 'GET' // 使用 DELETE 请求来删除文件
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Delete successful:', data);
                alert(data.message);
                fetchImages();
            } catch (error) {
                console.error('There was a problem with your delete operation:', error);
            }
        }

        function goBack() {
            window.history.back();
        }
    </script>
</body>

</html>